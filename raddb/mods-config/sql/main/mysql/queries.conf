# -*- text -*-
#
#  main/mysql/queries.conf-- MySQL configuration for default schema (schema.sql)
#
#  $Id: 0b3c210d6c0b04350d1a48738764b47f25f51bc4 $

# Safe characters list for sql queries. Everything else is replaced
# with their mime-encoded equivalents.
# The default list should be ok
safe_characters = "@abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789.-_: /<>;=*+\""

#######################################################################
#  Connection config
#######################################################################
# The character set is not configurable. The default character set of
# the mysql client library is used. To control the character set,
# create/edit my.cnf (typically in /etc/mysql/my.cnf or /etc/my.cnf)
# and enter
# [client]
# default-character-set = utf8
#

#######################################################################
#  Query config:  Username
#######################################################################
# This is the username that will get substituted, escaped, and added
# as attribute 'SQL-User-Name'. '%{SQL-User-Name}' should be used below
# everywhere a username substitution is needed so you you can be sure
# the username passed from the client is escaped properly.
#
# Uncomment the next line, if you want the sql_user_name to mean:
#
#	Use Stripped-User-Name, if it's there.
#	Else use User-Name, if it's there,
#	Else use hard-coded string "DEFAULT" as the user name.
#sql_user_name = "%{%{Stripped-User-Name}:-%{%{User-Name}:-DEFAULT}}"
#
sql_user_name = "%{User-Name}"

#######################################################################
# Default profile
#######################################################################
# This is the default profile. It is found in SQL by group membership.
# That means that this profile must be a member of at least one group
# which will contain the corresponding check and reply items.
# This profile will be queried in the authorize section for every user.
# The point is to assign all users a default profile without having to
# manually add each one to a group that will contain the profile.
# The SQL module will also honor the User-Profile attribute. This
# attribute can be set anywhere in the authorize section (ie the users
# file). It is found exactly as the default profile is found.
# If it is set then it will *overwrite* the default profile setting.
# The idea is to select profiles based on checks on the incoming packets,
# not on user group membership. For example:
# -- users file --
# DEFAULT	Service-Type == Outbound-User, User-Profile := "outbound"
# DEFAULT	Service-Type == Framed-User, User-Profile := "framed"
#
# By default the default_user_profile is not set
#
#default_user_profile = "DEFAULT"

#######################################################################
# NAS Query
#######################################################################
# This query retrieves the radius clients
#
# 0. Row ID (currently unused)
# 1. Name (or IP address)
# 2. Shortname
# 3. Type
# 4. Secret
# 5. Server
#######################################################################

client_query = "\
	SELECT id, nasname, shortname, type, secret, server \
	FROM ${client_table}"

#######################################################################
# Authorization Queries
#######################################################################
# These queries compare the check items for the user
# in ${authcheck_table} and setup the reply items in
# ${authreply_table}. You can use any query/tables
# you want, but the return data for each row MUST
# be in the following order:
#
# 0. Row ID (currently unused)
# 1. UserName/GroupName
# 2. Item Attr Name
# 3. Item Attr Value
# 4. Item Attr Operation
#######################################################################
# Use these for case sensitive usernames.

#authorize_check_query = "\
#	SELECT id, username, attribute, value, op \
#	FROM ${authcheck_table} \
#	WHERE username = BINARY '%{SQL-User-Name}' \
#	ORDER BY id"

#authorize_reply_query = "\
#	SELECT id, username, attribute, value, op \
#	FROM ${authreply_table} \
#	WHERE username = BINARY '%{SQL-User-Name}' \
#	ORDER BY id"

#
#  The default queries are case insensitive. (for compatibility with
#  older versions of FreeRADIUS)
#
authorize_check_query = "\
	SELECT id, username, attribute, value, op \
	FROM ${authcheck_table} \
	WHERE username = '%{SQL-User-Name}' \
	ORDER BY id"

authorize_reply_query = "\
	SELECT id, username, attribute, value, op \
	FROM ${authreply_table} \
	WHERE username = '%{SQL-User-Name}' \
	ORDER BY id"

#
#  Use these for case sensitive usernames.
#
group_membership_query = "\
#	SELECT groupname \
#	FROM ${usergroup_table} \
#	WHERE username = BINARY '%{SQL-User-Name}' \
#	ORDER BY priority"

group_membership_query = "\
	SELECT groupname \
	FROM ${usergroup_table} \
	WHERE username = '%{SQL-User-Name}' \
	ORDER BY priority"

authorize_group_check_query = "\
	SELECT id, groupname, attribute, \
	Value, op \
	FROM ${groupcheck_table} \
	WHERE groupname = '%{Sql-Group}' \
	ORDER BY id"

authorize_group_reply_query = "\
	SELECT id, groupname, attribute, \
	value, op \
	FROM ${groupreply_table} \
	WHERE groupname = '%{Sql-Group}' \
	ORDER BY id"

#######################################################################
# Simultaneous Use Checking Queries
#######################################################################
# simul_count_query	- query for the number of current connections
#			- If this is not defined, no simultaneouls use checking
#			- will be performed by this module instance
# simul_verify_query	- query to return details of current connections
#				for verification
#			- Leave blank or commented out to disable verification step
#			- Note that the returned field order should not be changed.
#######################################################################

#
#  Uncomment simul_count_query to enable simultaneous use checking
#
#simul_count_query = "\
#	SELECT COUNT(*) \
#	FROM ${acct_table1} \
#	WHERE username = '%{SQL-User-Name}' \
#	AND acctstoptime IS NULL"

simul_verify_query = "\
	SELECT \
		radacctid, acctsessionid, username, nasipaddress, nasportid, framedipaddress, \
		callingstationid, framedprotocol \
	FROM ${acct_table1} \
	WHERE username = '%{SQL-User-Name}' \
	AND acctstoptime IS NULL"

#######################################################################
# Accounting and Post-Auth Queries
#######################################################################
# These queries insert/update accounting and authentication records.
# The query to use is determined by the value of 'reference'.
# This value is used as a configuration path and should resolve to one
# or more 'query's. If reference points to multiple queries, and a query
# fails, the next query is executed.
#
# Behaviour is identical to the old 1.x/2.x module, except we can now
# fail between N queries, and query selection can be based on any
# combination of attributes, or custom 'Acct-Status-Type' values.
#######################################################################
accounting {
	reference = "%{tolower:type.%{Acct-Status-Type}.query}"

	# Write SQL queries to a logfile. This is potentially useful for bulk inserts
	# when used with the rlm_sql_null driver.
	logfile = ${logdir}/accounting.sql

	column_list = "\
		acctsessionid,		acctuniqueid,		username, \
		realm,			nasipaddress,		nasportid, \
		nasporttype,		acctstarttime,		acctupdatetime, \
		acctstoptime,		acctsessiontime, 	acctauthentic, \
		connectinfo_start,	connectinfo_stop, 	acctinputoctets, \
		acctoutputoctets,	calledstationid, 	callingstationid, \
		acctterminatecause,	servicetype,		framedprotocol, \
		framedipaddress"  
    column_list3 = "\
        acctsessionid,		acctuniqueid, nasipaddress, \
        netsessioningresscallid, netsessionegresscallid, netsessiongenericid, \
        netingresssignalinggroup, netegresssignalinggroup, netingresschannelnumber, \
        netegresschannelnumber, netcallorigin, netcallingnumber, \
        netcallednumber, netcallingname, netingresschannelid, \
        netegresschannelid, netcallpriority, netrecordingtype, \
        netrecordingleg, netsetuptime, netppreferredid, \
        netfirmwareversion, netlocaltimezone, netgwid, \
        nettimeandday, netlogtime"

    column_list2 = "\
        acctsessionid,		acctuniqueid, nasipaddress, \
        netfwdflowinrealm,      netfwdflowinsrcaddr,   netfwdflowinsrcport, \
        netfwdflowindstaddr,   netfwdflowindstport,   netfwdflowoutrealm, \
        netfwdflowoutsrcaddr,  netfwdflowoutsrcport,  netfwdflowoutdstaddr, \
        netfwdflowoutdstport,  netbwdflowinrealm,  netbwdflowinsrcaddr, \
        netbwdflowinsrcport,   netbwdflowindstaddr,   netbwdflowindstport, \
        netbwdflowoutrealm,     netbwdflowoutsrcaddr,  netbwdflowoutsrcport, \
        netbwdflowoutdstaddr,  netbwdflowoutdstport,  netfwdflowmediatype, \
        netfwdflowptime,         netfwdoctets,             netfwdpackets, \
        netfwdrtcppacketslost,  netfwdrtcpavgjitter,    netfwdrtpavglatency, \
        netfwdrtcpmaxjitter,     netfwdrtpmaxlatency,     netfwdrtppacketslost, \
        netfwdrtpavgjitter,     netfwdrtpmaxjitter,      netbwdmaxpacketoutage, \
        netbwdoctets,             netbwdpackets,            netbwdrtcppacketslost, \
        netbwdrtcpavgjitter,    netbwdrtpavglatency,    netbwdrtcpmaxjitter, \
        netbwdrtpmaxlatency,     netbwdrtppacketslost,   netbwdrtpavgjitter, \
        netbwdrtpmaxjitter,      netrtppacketsdiscarded,  netsessioningresscallid, \
        netsessionegresscallid,  netsessiongenericid,     netroutingtablenumber, \
        netingresssignalinggroup,    netegresssignalinggroup, netprimaryroutingnumber, \
        netegressfinalroutingnum,   netingresschannelnumber, netegresschannelnumber, \
        netcalltype,              netcallorigin,            netcallingnumber, \
        netcallednumber,          netcallingname,           netdisconnectcause, \
        netabortcause,            netingresschannelid,     netegresschannelid, \
        netcallpriority,          netrecordingtype,         netrecordingleg, \
        netcallnumbertype,       netcallplan,              netoriginalcallednumber, \
        netoriginalcalledtype,   netoriginalcalledplan,   netcalledname, \
        netnamespace,              netprecedence,             netpresentation, \
        netscreening,              nettransfercapability,    nettransfermode, \
        nettransferrate,          netuserrate,              netsetuptime, \
        netalerttime,             netconnecttime,           netdisconnecttime, \
        netinboundseizetime,     netoutboundseizetime,    netcallduration, \
        netpostdialdelay,        netdisconnectinitiator,   netpassertedid, \
        netsipdiversion,          netingresslocaladdr,     netingressremoteaddr, \
        netegresslocaladdr,      netegressremoteaddr,     netingressnetinterfaceid, \
        netegressnetinterfaceid,    netrefercalltransferid, netsessionforkedcallid, \
        netredirectnumber,        netredirectipaddress,    netsessioningressrealm, \
        netsessionegressrealm,   netingresssignalingportnum, netegresssignalingportnum, \
        nettransporttype,         netppreferredid,         netingsignalingremportnum, \
        netegsignalingremportnum,  netingresssipcallid,    netegresssipcallid, \
        netfirmwareversion,       netlocaltimezone,        netgwid, \
        nettimeandday,           netlogtime,               netsiprecordingrtprxipaddr, \
        netsiprecordingrtptxipaddr, netrxpacketsent,     netrxoctetsent, \
        netrxpacketlost,         nettxpacketsent,         nettxoctetsent, \
        nettxpacketlost"
    
	type {
		accounting-on {
			#
			#  Bulk terminate all sessions associated with a given NAS
			#
			query = "\
				UPDATE ${....acct_table1} \
				SET \
					acctstoptime = FROM_UNIXTIME(\
						%{integer:Event-Timestamp}), \
					acctsessiontime	= '%{integer:Event-Timestamp}' \
						- UNIX_TIMESTAMP(acctstarttime), \
					acctterminatecause = '%{%{Acct-Terminate-Cause}:-NAS-Reboot}' \
				WHERE acctstoptime IS NULL \
				AND nasipaddress   = '%{NAS-IP-Address}' \
				AND acctstarttime <= FROM_UNIXTIME(\
					%{integer:Event-Timestamp})"
		}

		accounting-off {
			query = "${..accounting-on.query}"
		}

		start {
			#
			#  Insert a new record into the sessions table
			#
			#query = "\
			#	INSERT INTO ${....acct_table1} \
			#		(${...column_list},${...column_list3}) \
			#	VALUES \
			#		('%{Acct-Session-Id}', \
			#		'%{Acct-Unique-Session-Id}', \
			#		'%{SQL-User-Name}', \
			#		'%{Realm}', \
			#		'%{NAS-IP-Address}', \
			#		'%{NAS-Port}', \
			#		'%{NAS-Port-Type}', \
			#		FROM_UNIXTIME(%{integer:Event-Timestamp}), \
			#		FROM_UNIXTIME(%{integer:Event-Timestamp}), \
			#		NULL, \
			#		'0', \
			#		'%{Acct-Authentic}', \
			#		'%{Connect-Info}', \
			#		'', \
			#		'0', \
			#		'0', \
			#		'%{Called-Station-Id}', \
			#		'%{Calling-Station-Id}', \
			#		'', \
			#		'%{Service-Type}', \
			#		'%{Framed-Protocol}', \
			#		'%{Framed-IP-Address}');"
            query = "INSERT INTO ${....acct_table3} \
                    (${...column_list3}) \
                    VALUES \
                    ('%{Acct-Session-Id}', \
					'%{Acct-Unique-Session-Id}', \
                    '%{NAS-IP-Address}', \
                    '%{%{NET-Session-Ingress-CallId}:-65535}', \
                    '%{%{NET-Session-Egress-CallId}:-65535}', \
                    '%{NET-Session-Generic-Id}', \
                    '%{%{NET-Ingress-Signaling-Group}:-0}', \
                    '%{%{NET-Egress-Signaling-Group}:-0}', \
                    '%{%{NET-Ingress-Channel-Number}:-0}', \
                    '%{%{NET-Egress-Channel-Number}:-0}', \
                    '%{%{NET-Call-Origin}:-0}', \
                    '%{NET-Calling-Number}', \
                    '%{NET-Called-Number}', \
                    '%{NET-Calling-Name}', \
                    '%{%{NET-Ingress-Channel-Id}:-0}', \
                    '%{%{NET-Egress-Channel-Id}:-0}', \
                    '%{NET-Call-Priority}', \
                    '%{NET-Recording-Type}', \
                    '%{NET-Recording-Leg}', \
                    '%{NET-Setup-Time}', \
                    '%{NET-P-Preferred-ID}', \
                    '%{NET-Firmware-Version}', \
                    '%{NET-Local-Time-Zone}', \
                    '%{NET-Gw-Id}', \
                    '%{NET-Time-And-Day}', \
                    '%{NET-Log-Time}' \
                    );"

			#
			#  Key constraints prevented us from inserting a new session,
			#  use the alternate query to update an existing session.
			#
			#query = "\
			#	UPDATE ${....acct_table1} SET \
			#		acctstarttime	= FROM_UNIXTIME(%{integer:Event-Timestamp}), \
			#		acctupdatetime	= FROM_UNIXTIME(%{integer:Event-Timestamp}), \
			#		connectinfo_start = '%{Connect-Info}', \
            query = "\
                UPDATE ${....acct_table3} SET \
                    netsessioningresscallid='%{%{NET-Session-Ingress-CallId}:-65535}', \
                    netsessionegresscallid='%{%{NET-Session-Egress-CallId}:-65535}', \
                    netsessiongenericid='%{NET-Session-Generic-Id}', \
                    netingresssignalinggroup='%{%{NET-Ingress-Signaling-Group}:-0}', \
                    netegresssignalinggroup='%{%{NET-Egress-Signaling-Group}:-0}', \
                    netingresschannelnumber='%{%{NET-Ingress-Channel-Number}:-0}', \
                    netegresschannelnumber='%{%{NET-Egress-Channel-Number}:-0}', \
                    netcallorigin='%{%{NET-Call-Origin}:-0}', \
                    netcallingnumber='%{NET-Calling-Number}', \
                    netcallednumber='%{NET-Called-Number}', \
                    netcallingname='%{NET-Calling-Name}', \
                    netingresschannelid='%{%{NET-Ingress-Channel-Id}:-0}', \
                    netegresschannelid='%{%{NET-Egress-Channel-Id}:-0}', \
                    netcallpriority='%{NET-Call-Priority}', \
                    netrecordingtype='%{NET-Recording-Type}', \
                    netrecordingleg='%{NET-Recording-Leg}', \
                    netsetuptime='%{NET-Setup-Time}', \
                    netppreferredid='%{NET-P-Preferred-ID}', \
                    netfirmwareversion='%{NET-Firmware-Version}', \
                    netlocaltimezone='%{NET-Local-Time-Zone}', \
                    netgwid='%{NET-Gw-Id}', \
                    nettimeandday='%{NET-Time-And-Day}', \
                    netlogtime='%{NET-Log-Time}' \
    			WHERE acctsessionid = '%{Acct-Session-Id}';"
              
		}

		interim-update {
			#
			#  Update an existing session and calculate the interval
			#  between the last data we received for the session and this
			#  update. This can be used to find stale sessions.
			#
			query = "\
				UPDATE ${....acct_table1} \
				SET \
					acctupdatetime  = (@acctupdatetime_old:=acctupdatetime), \
					acctupdatetime  = FROM_UNIXTIME(\
						%{integer:Event-Timestamp}), \
					acctinterval    = %{integer:Event-Timestamp} - \
						UNIX_TIMESTAMP(@acctupdatetime_old), \
					framedipaddress = '%{Framed-IP-Address}', \
					acctsessiontime = '%{Acct-Session-Time}', \
					acctinputoctets = '%{%{Acct-Input-Gigawords}:-0}' \
						<< 32 | '%{%{Acct-Input-Octets}:-0}', \
					acctoutputoctets = '%{%{Acct-Output-Gigawords}:-0}' \
						<< 32 | '%{%{Acct-Output-Octets}:-0}' \
				WHERE acctsessionid     = '%{Acct-Session-Id}' \
				AND username            = '%{SQL-User-Name}' \
				AND nasipaddress        = '%{NAS-IP-Address}'"

			#
			#  The update condition matched no existing sessions. Use
			#  the values provided in the update to create a new session.
			#
			query = "\
				INSERT INTO ${....acct_table1} \
					(${...column_list}) \
				VALUES \
					('%{Acct-Session-Id}', \
					'%{Acct-Unique-Session-Id}', \
					'%{SQL-User-Name}', \
					'%{Realm}', \
					'%{NAS-IP-Address}', \
					'%{NAS-Port}', \
					'%{NAS-Port-Type}', \
					FROM_UNIXTIME(%{integer:Event-Timestamp} - \
						%{%{Acct-Session-Time}:-0}), \
					FROM_UNIXTIME(%{integer:Event-Timestamp}), \
					NULL, \
					'%{Acct-Session-Time}', \
					'%{Acct-Authentic}', \
					'%{Connect-Info}', \
					'', \
					'%{%{Acct-Input-Gigawords}:-0}' << 32 | \
						'%{%{Acct-Input-Octets}:-0}', \
					'%{%{Acct-Output-Gigawords}:-0}' << 32 | \
						'%{%{Acct-Output-Octets}:-0}', \
					'%{Called-Station-Id}', \
					'%{Calling-Station-Id}', \
					'', \
					'%{Service-Type}', \
					'%{Framed-Protocol}', \
					'%{Framed-IP-Address}')"
		}

		stop {
			#
			#  Session has terminated, update the stop time and statistics.
			#
			#query = "\
			#	UPDATE ${....acct_table2} SET \
			#		acctstoptime	= FROM_UNIXTIME(\
			#			%{integer:Event-Timestamp}), \
			#		acctsessiontime	= '%{Acct-Session-Time}', \
			#		acctinputoctets	= '%{%{Acct-Input-Gigawords}:-0}' \
			#			<< 32 | '%{%{Acct-Input-Octets}:-0}', \
			#		acctoutputoctets = '%{%{Acct-Output-Gigawords}:-0}' \
			#			<< 32 | '%{%{Acct-Output-Octets}:-0}', \
			#		acctterminatecause = '%{Acct-Terminate-Cause}', \
			#		connectinfo_stop = '%{Connect-Info}', \
            query = "\
                UPDATE ${....acct_table3} SET \
                    netfwdflowinrealm='%{NET-Fwd-Flow-In-Realm}', \
                    netfwdflowinsrcaddr='%{NET-Fwd-Flow-In-Src-Addr}', \
                    netfwdflowinsrcport= '%{%{NET-Fwd-Flow-In-Src-Port}:-0}', \
                    netfwdflowindstaddr='%{NET-Fwd-Flow-In-Dst-Addr}', \
                    netfwdflowindstport='%{%{NET-Fwd-Flow-In-Dst-Port}:-0}', \
                    netfwdflowoutrealm='%{NET-Fwd-Flow-Out-Realm}', \
                    netfwdflowoutsrcaddr='%{NET-Fwd-Flow-Out-Src-Addr}', \
                    netfwdflowoutsrcport= '%{%{NET-Fwd-Flow-Out-Src-Port}:-0}', \
                    netfwdflowoutdstaddr='%{NET-Fwd-Flow-Out-Dst-Addr}', \
                    netfwdflowoutdstport= '%{%{NET-Fwd-Flow-Out-Dst-Port}:-0}', \
                    netbwdflowinrealm='%{NET-Bwd-Flow-In-Realm}', \
                    netbwdflowinsrcaddr='%{NET-Bwd-Flow-In-Src-Addr}', \
                    netbwdflowinsrcport= '%{%{NET-Bwd-Flow-In-Src-Port}:-0}', \
                    netbwdflowindstaddr='%{NET-Bwd-Flow-In-Dst-Addr}', \
                    netbwdflowindstport='%{%{NET-Bwd-Flow-In-Dst-Port}:-0}', \
                    netbwdflowoutrealm='%{NET-Bwd-Flow-Out-Realm}', \
                    netbwdflowoutsrcaddr='%{NET-Bwd-Flow-Out-Src-Addr}', \
                    netbwdflowoutsrcport='%{%{NET-Bwd-Flow-Out-Src-Port}:-0}', \
                    netbwdflowoutdstaddr='%{NET-Bwd-Flow-Out-Dst-Addr}', \
                    netbwdflowoutdstport='%{%{NET-Bwd-Flow-Out-Dst-Port}:-0}', \
                    netfwdflowmediatype='%{NET-Fwd-Flow-Media-Type}', \
                    netfwdflowptime='%{%{NET-Fwd-Flow-PTime}:-0}', \
                    netfwdoctets=' %{%{NET-Fwd-Octets}:-0}', \
                    netfwdpackets='%{%{NET-Fwd-Packets}:-0}', \
                    netfwdrtcppacketslost='%{%{NET-Fwd-RTCP-Packets-Lost}:-0}', \
                    netfwdrtcpavgjitter='%{%{NET-Fwd-RTCP-Avg-Jitter}:-0}', \
                    netfwdrtpavglatency='%{%{NET-Fwd-RTP-Avg-Latency}:-0}', \
                    netfwdrtcpmaxjitter='%{%{NET-Fwd-RTCP-MaxJitter}:-0}', \
                    netfwdrtpmaxlatency=' %{%{NET-Fwd-RTP-MaxLatency}:-0}', \
                    netfwdrtppacketslost='%{%{NET-Fwd-RTP-Packets-Lost}:-0}', \
                    netfwdrtpavgjitter='%{%{NET-Fwd-RTP-Avg-Jitter}:-0}', \
                    netfwdrtpmaxjitter='%{%{NET-Fwd-RTP-MaxJitter}:-0}', \
                    netbwdmaxpacketoutage='%{%{NET-Bwd-Max-Packet-Outage}:-0}', \
                    netbwdoctets='%{%{NET-Bwd-Octets}:-0}', \
                    netbwdpackets='%{%{NET-Bwd-Packets}:-0}', \
                    netbwdrtcppackets-Lost='%{%{:NET-Bwd-RTCP-Packets-Lost}:-0}', \
                    netbwdrtcpavgjitter='%{%{NET-Bwd-RTCP-Avg-Jitter}:-0}', \
                    netbwdrtpavglatency='%{%{NET-Bwd-RTP-Avg-Latency}:-0}', \
                    netbwdrtcpmaxjitter='%{%{NET-Bwd-RTCP-MaxJitter}:-0}', \
                    netbwdrtpmaxlatency='%{%{NET-Bwd-RTP-MaxLatency}:-0}', \
                    netbwdrtppacketslost='%{%{NET-Bwd-RTP-Packets-Lost}:-0}', \
                    netbwdrtpavgjitter='%{%{NET-Bwd-RTP-Avg-Jitter}:-0}', \
                    netbwdrtpmaxjitter='%{%{NET-Bwd-RTP-MaxJitter}:-0}', \
                    netrtppacketsdiscarded='%{%{NET-RTP-Packets-Discarded}:-0}', \
                    netsessioningresscallid='%{%{NET-Session-Ingress-CallId}:-65535}', \
                    netsessionegresscallid='%{%{NET-Session-Egress-CallId}:-65535}', \
                    netsessiongenericid='%{NET-Session-Generic-Id}', \
                    netroutingtablenumber='%{%{NET-Routing-Table-Number}:-0}', \
                    netingresssignalinggroup='%{%{NET-Ingress-Signaling-Group}:-0}', \
                    netegresssignalinggroup='%{%{NET-Egress-Signaling-Group}:-0}', \
                    netprimaryroutingnumber='%{NET-Primary-Routing-Number}', \
                    netegressfinalroutingnum='%{NET-Egress-Final-Routing-Num}', \
                    netingresschannelnumber='%{%{NET-Ingress-Channel-Number}:-0}', \
                    netegresschannelnumber='%{%{NET-Egress-Channel-Number}:-0}', \
                    netcalltype='%{%{NET-Call-Type}:-0}', \
                    netcallorigin='%{%{NET-Call-Origin}:-0}', \
                    netcallingnumber='%{NET-Calling-Number}', \
                    netcallednumber='%{NET-Called-Number}', \
                    netcallingname='%{NET-Calling-Name}', \
                    netdisconnectcause='%{%{NET-Disconnect-Cause}:-0}', \
                    netabortcause='%{%{NET-Abort-Cause}:-0}', \
                    netingresschannel-Id='%{%{NET-Ingress-Channel-Id}:-0}', \
                    netegresschannel-Id='%{%{NET-Egress-Channel-Id}:-0}', \
                    netcallpriority='%{NET-Call-Priority}', \
                    netrecordingtype='%{NET-Recording-Type}', \
                    netrecordingleg='%{NET-Recording-Leg}', \
                    netcallnumbertype='%{%{NET-Call-Number-Type}:--1}', \
                    netcallplan='%{%{NET-Call-Plan}:--1}', \
                    netoriginalcallednumber='%{NET-Original-Called-Number}', \
                    netoriginalcalledtype='%{%{NET-Original-Called-Type}:--1}', \
                    netoriginalcalledplan='%{%{NET-Original-Called-Plan}:--1}', \
                    netcalledname='%{NET-Called-Name}', \
                    netnamespace='%{%{NET-Namespace}:--3}', \
                    netprecedence='%{%{NET-Precedence}:--1}', \
                    netpresentation='%{%{NET-Presentation}:--1}', \
                    netscreening='%{%{NET-Screening}:--1}', \
                    nettransfercapability='%{%{NET-Transfer-Capability}:--1}', \
                    nettransfermode='%{%{NET-Transfer-Mode}:--1}', \
                    nettransferrate='%{%{NET-Transfer-Rate}:--1}', \
                    netuserrate='%{%{NET-User-Rate}:--1}', \
                    netsetuptime='%{NET-Setup-Time}', \
                    netalerttime='%{NET-Alert-Time}', \
                    netconnecttime='%{NET-Connect-Time}', \
                    netdisconnecttime='%{NET-Disconnect-Time}', \
                    netinboundseizetime='%{NET-Inbound-Seize-Time}', \
                    netoutboundseizetime='%{NET-Outbound-Seize-Time}', \
                    netcallduration='%{%{NET-Call-Duration}:-0}', \
                    netpostdialdelay='%{%{NET-Post-Dial-Delay}:-0}', \
                    netdisconnectinitiator='%{%{NET-Disconnect-Initiator}:-0}', \
                    netpassertedid='%{string:NET-P-Asserted-ID}', \
                    netsipdiversion='%{NET-SIP-Diversion}', \
                    netingresslocaladdr='%{NET-Ingress-Local-Addr}', \
                    netingressremoteaddr='%{NET-Ingress-Remote-Addr}', \
                    netegresslocaladdr='%{NET-Egress-Local-Addr}', \
                    netegressremoteaddr='%{NET-Egress-Remote-Addr}', \
                    netingressnetinterfaceid='%{%{NET-Ingress-Net-Interface-Id}:-0}', \
                    netegressnetinterfaceid='%{%{NET-Egress-Net-Interface-Id}:-0}', \
                    netrefercalltransferid='%{NET-Refer-Call-Transfer-Id}', \
                    netsessionforkedcallid='%{NET-Session-Forked-Call-Id}', \
                    netredirectnumber='%{NET-Redirect-Number}', \
                    netredirectipaddress='%{%{NET-Redirect-Ip-Address}:-}', \
                    netsessioningressrealm='%{NET-Session-Ingress-Realm}', \
                    netsessionegressrealm='%{NET-Session-Egress-Realm}', \
                    netingresssignalingportnum='%{%{NET-Ingress-Signaling-Port-Num}:-0}', \
                    netegresssignalingportnum='%{%{NET-Egress-Signaling-Port-Num}:-0}', \
                    nettransporttype='%{%{NET-Transport-Type}:-0}', \
                    netppreferredid='%{NET-P-Preferred-ID}', \
                    netingsignalingremportnum='%{%{NET-Ing-Signaling-Rem-Port-Num}:-0}', \
                    netegsignalingremportnum='%{%{NET-Eg-Signaling-Rem-Port-Num}:-0}', \
                    netingresssipcallid='%{NET-Ingress-SIP-Call-Id}', \
                    netegresssipcallid='%{NET-Egress-SIP-Call-Id}', \
                    netfirmwareversion='%{NET-Firmware-Version}', \
                    netlocaltimezone='%{NET-Local-Time-Zone}', \
                    netgwid='%{NET-Gw-Id}', \
                    nettimeandday='%{NET-Time-And-Day}', \
                    netlogtime='%{NET-Log-Time}', \
                    netsiprecordingrtprxipaddr='%{NET-SIPRecording-RTP-Rx-IpAddr}', \
                    netsiprecordingrtptxipaddr='%{NET-SIPRecording-RTP-Tx-IpAddr}', \
                    netrxpacketsent='%{%{NET-Rx-Packet-Sent}:-0}', \
                    netrxoctetsent='%{%{NET-Rx-Octet-Sent}:-0}', \
                    netrxpacketlost='%{%{NET-Rx-Packet-Lost}:-0}', \
                    nettxpacketsent='%{%{NET-Tx-Packet-Sent}:-0}', \
                    nettxoctetsent='%{%{NET-Tx-Octet-Sent}:-0}', \
                    nettxpacketlost='%{%{NET-Tx-Packet-Lost}:-0}' \
				WHERE acctsessionid 	= '%{Acct-Session-Id}'"

			#
			#  The update condition matched no existing sessions. Use
			#  the values provided in the update to create a new session.
			#
			#query = "\
			#	INSERT INTO ${....acct_table2} \
			#		(${...column_list},${...column_list2}) \
			#	VALUES \
			#		('%{Acct-Session-Id}', \
			#		'%{Acct-Unique-Session-Id}', \
			#		'%{SQL-User-Name}', \
			#		'%{Realm}', \
			#		'%{NAS-IP-Address}', \
			#		'%{NAS-Port}', \
			#		'%{NAS-Port-Type}', \
			#		FROM_UNIXTIME(%{integer:Event-Timestamp} - \
			#			%{%{Acct-Session-Time}:-0}), \
			#		FROM_UNIXTIME(%{integer:Event-Timestamp}), \
			#		FROM_UNIXTIME(%{integer:Event-Timestamp}), \
			#		'%{Acct-Session-Time}', \
			#		'%{Acct-Authentic}', '', \
			#		'%{Connect-Info}', \
			#		'%{%{Acct-Input-Gigawords}:-0}' << 32 | \
			#			'%{%{Acct-Input-Octets}:-0}', \
			#		'%{%{Acct-Output-Gigawords}:-0}' << 32 | \
			#			'%{%{Acct-Output-Octets}:-0}', \
			#		'%{Called-Station-Id}', \
			#		'%{Calling-Station-Id}', \
			#		'%{Acct-Terminate-Cause}', \
			#		'%{Service-Type}', \
			#		'%{Framed-Protocol}', \
			#		'%{Framed-IP-Address}', \
            query = "\
                INSERT INTO ${....acct_table3} \
                    (${...column_list2}) \
                VALUES \
                    ('%{Acct-Session-Id}', \
					'%{Acct-Unique-Session-Id}', \
                    '%{NAS-IP-Address}', \
                    '%{NET-Fwd-Flow-In-Realm}', \
                    '%{NET-Fwd-Flow-In-Src-Addr}', \
                    '%{%{NET-Fwd-Flow-In-Src-Port}:-0}', \
                    '%{NET-Fwd-Flow-In-Dst-Addr}', \
                    '%{%{NET-Fwd-Flow-In-Dst-Port}:-0}', \
                    '%{NET-Fwd-Flow-Out-Realm}', \
                    '%{NET-Fwd-Flow-Out-Src-Addr}', \
                    '%{%{NET-Fwd-Flow-Out-Src-Port}:-0}', \
                    '%{NET-Fwd-Flow-Out-Dst-Addr}', \
                    '%{%{NET-Fwd-Flow-Out-Dst-Port}:-0}', \
                    '%{NET-Bwd-Flow-In-Realm}', \
                    '%{NET-Bwd-Flow-In-Src-Addr}', \
                    '%{%{NET-Bwd-Flow-In-Src-Port}:-0}', \
                    '%{NET-Bwd-Flow-In-Dst-Addr}', \
                    '%{%{NET-Bwd-Flow-In-Dst-Port}:-0}', \
                    '%{NET-Bwd-Flow-Out-Realm}', \
                    '%{NET-Bwd-Flow-Out-Src-Addr}', \
                    '%{%{NET-Bwd-Flow-Out-Src-Port}:-0}', \
                    '%{NET-Bwd-Flow-Out-Dst-Addr}', \
                    '%{%{NET-Bwd-Flow-Out-Dst-Port}:-0}', \
                    '%{NET-Fwd-Flow-Media-Type}', \
                    '%{%{NET-Fwd-Flow-PTime}:-0}', \
                    '%{%{NET-Fwd-Octets}:-0}', \
                    '%{%{NET-Fwd-Packets}:-0}', \
                    '%{%{NET-Fwd-RTCP-Packets-Lost}:-0}', \
                    '%{%{NET-Fwd-RTCP-Avg-Jitter}:-0}', \
                    '%{%{NET-Fwd-RTP-Avg-Latency}:-0}', \
                    '%{%{NET-Fwd-RTCP-MaxJitter}:-0}', \
                    '%{%{NET-Fwd-RTP-MaxLatency}:-0}', \
                    '%{%{NET-Fwd-RTP-Packets-Lost}:-0}', \
                    '%{%{NET-Fwd-RTP-Avg-Jitter}:-0}', \
                    '%{%{NET-Fwd-RTP-MaxJitter}:-0}', \
                    '%{%{NET-Bwd-Max-Packet-Outage}:-0}', \
                    '%{%{NET-Bwd-Octets}:-0}', \
                    '%{%{NET-Bwd-Packets}:-0}', \
                    '%{%{NET-Bwd-RTCP-Packets-Lost}:-0}', \
                    '%{%{NET-Bwd-RTCP-Avg-Jitter}:-0}', \
                    '%{%{NET-Bwd-RTP-Avg-Latency}:-0}', \
                    '%{%{NET-Bwd-RTCP-MaxJitter}:-0}', \
                    '%{%{NET-Bwd-RTP-MaxLatency}:-0}', \
                    '%{%{NET-Bwd-RTP-Packets-Lost}:-0}', \
                    '%{%{NET-Bwd-RTP-Avg-Jitter}:-0}', \
                    '%{%{NET-Bwd-RTP-MaxJitter}:-0}', \
                    '%{%{NET-RTP-Packets-Discarded}:-0}', \
                    '%{%{NET-Session-Ingress-CallId}:-65535}', \
                    '%{%{NET-Session-Egress-CallId}:-65535}', \
                    '%{NET-Session-Generic-Id}', \
                    '%{%{NET-Routing-Table-Number}:-0}', \
                    '%{%{NET-Ingress-Signaling-Group}:-0}', \
                    '%{%{NET-Egress-Signaling-Group}:-0}', \
                    '%{NET-Primary-Routing-Number}', \
                    '%{NET-Egress-Final-Routing-Num}', \
                    '%{%{NET-Ingress-Channel-Number}:-0}', \
                    '%{%{NET-Egress-Channel-Number}:-0}', \
                    '%{%{NET-Call-Type}:-0}', \
                    '%{%{NET-Call-Origin}:-0}', \
                    '%{NET-Calling-Number}', \
                    '%{NET-Called-Number}', \
                    '%{NET-Calling-Name}', \
                    '%{%{NET-Disconnect-Cause}:-0}', \
                    '%{%{NET-Abort-Cause}:-0}', \
                    '%{%{NET-Ingress-Channel-Id}:-0}', \
                    '%{%{NET-Egress-Channel-Id}:-0}', \
                    '%{NET-Call-Priority}', \
                    '%{NET-Recording-Type}', \
                    '%{NET-Recording-Leg}', \
                    '%{%{NET-Call-Number-Type}:--1}', \
                    '%{%{NET-Call-Plan}:--1}', \
                    '%{NET-Original-Called-Number}', \
                    '%{%{NET-Original-Called-Type}:--1}', \
                    '%{%{NET-Original-Called-Plan}:--1}', \
                    '%{NET-Called-Name}', \
                    '%{%{NET-Namespace}:--3}', \
                    '%{%{NET-Precedence}:--1}', \
                    '%{%{NET-Presentation}:--1}', \
                    '%{%{NET-Screening}:--1}', \
                    '%{%{NET-Transfer-Capability}:--1}', \
                    '%{%{NET-Transfer-Mode}:--1}', \
                    '%{%{NET-Transfer-Rate}:--1}', \
                    '%{%{NET-User-Rate}:--1}', \
                    '%{NET-Setup-Time}', \
                    '%{NET-Alert-Time}', \
                    '%{NET-Connect-Time}', \
                    '%{NET-Disconnect-Time}', \
                    '%{NET-Inbound-Seize-Time}', \
                    '%{NET-Outbound-Seize-Time}', \
                    '%{%{NET-Call-Duration}:-0}', \
                    '%{%{NET-Post-Dial-Delay}:-0}', \
                    '%{%{NET-Disconnect-Initiator}:-0}', \
                    '%{NET-P-Asserted-ID}', \
                    '%{NET-SIP-Diversion}', \
                    '%{NET-Ingress-Local-Addr}', \
                    '%{NET-Ingress-Remote-Addr}', \
                    '%{NET-Egress-Local-Addr}', \
                    '%{NET-Egress-Remote-Addr}', \
                    '%{%{NET-Ingress-Net-Interface-Id}:-0}', \
                    '%{%{NET-Egress-Net-Interface-Id}:-0}', \
                    '%{NET-Refer-Call-Transfer-Id}', \
                    '%{NET-Session-Forked-Call-Id}', \
                    '%{NET-Redirect-Number}', \
                    '%{%{NET-Redirect-Ip-Address}:-}', \
                    '%{NET-Session-Ingress-Realm}', \
                    '%{NET-Session-Egress-Realm}', \
                    '%{%{NET-Ingress-Signaling-Port-Num}:-0}', \
                    '%{%{NET-Egress-Signaling-Port-Num}:-0}', \
                    '%{%{NET-Transport-Type}:-0}', \
                    '%{NET-P-Preferred-ID}', \
                    '%{%{NET-Ing-Signaling-Rem-Port-Num}:-0}', \
                    '%{%{NET-Eg-Signaling-Rem-Port-Num}:-0}', \
                    '%{NET-Ingress-SIP-Call-Id}', \
                    '%{NET-Egress-SIP-Call-Id}', \
                    '%{NET-Firmware-Version}', \
                    '%{NET-Local-Time-Zone}', \
                    '%{NET-Gw-Id}', \
                    '%{NET-Time-And-Day}', \
                    '%{NET-Log-Time}', \
                    '%{NET-SIPRecording-RTP-Rx-IpAddr}', \
                    '%{NET-SIPRecording-RTP-Tx-IpAddr}', \
                    '%{%{NET-Rx-Packet-Sent}:-0}', \
                    '%{%{NET-Rx-Octet-Sent}:-0}', \
                    '%{%{NET-Rx-Packet-Lost}:-0}', \
                    '%{%{NET-Tx-Packet-Sent}:-0}', \
                    '%{%{NET-Tx-Octet-Sent}:-0}', \
                    '%{%{NET-Tx-Packet-Lost}:-0}');"
		}
	}
}

#######################################################################
# Authentication Logging Queries
#######################################################################
# postauth_query	- Insert some info after authentication
#######################################################################

post-auth {
	# Write SQL queries to a logfile. This is potentially useful for bulk inserts
	# when used with the rlm_sql_null driver.
#	logfile = ${logdir}/post-auth.sql

	query =	"\
		INSERT INTO ${..postauth_table} \
			(username, pass, reply, authdate) \
		VALUES ( \
			'%{SQL-User-Name}', \
			'%{%{User-Password}:-%{Chap-Password}}', \
			'%{reply:Packet-Type}', \
			'%S')"
}
